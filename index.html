<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Deer Tracker</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
<style>
* {
    margin: 0;
    padding: 0;
    box-sizing: border-box;
}

body {
    font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
    line-height: 1.6;
    color: #e0e0e0;
    background: #0a0a0a;
}

.container {
    max-width: 1200px;
    margin: 0 auto;
    padding: 0 1rem;
}

header {
    background: linear-gradient(135deg, #1a1a1a 0%, #0f0f0f 100%);
    padding: 2rem 0;
    text-align: center;
    border-bottom: 2px solid #00ff88;
    box-shadow: 0 4px 20px rgba(0, 255, 136, 0.1);
}

header h1 {
    font-size: 3rem;
    font-weight: 700;
    color: #00ff88;
    margin-bottom: 0.5rem;
    text-shadow: 0 0 20px rgba(0, 255, 136, 0.3);
}

header p {
    font-size: 1.2rem;
    color: #b0b0b0;
}

main {
    padding: 2rem 0;
}

section {
    background: #111;
    border-radius: 12px;
    padding: 2rem;
    margin-bottom: 2rem;
    border: 1px solid #222;
    box-shadow: 0 4px 20px rgba(0, 0, 0, 0.3);
}

section h2 {
    color: #00ff88;
    font-size: 1.8rem;
    margin-bottom: 1.5rem;
    border-bottom: 2px solid #222;
    padding-bottom: 0.5rem;
}

#map {
    height: 500px;
    border-radius: 8px;
    border: 2px solid #00ff88;
    margin-bottom: 1rem;
    box-shadow: 0 0 20px rgba(0, 255, 136, 0.2);
}

.map-info {
    color: #888;
    font-style: italic;
    margin-top: 1rem;
    text-align: center;
}
/* Zip search (above map) */
.map-search{
    margin-bottom: 1rem;
    padding: 1rem;
    border: 1px solid #222;
    border-radius: 12px;
    background: #0f0f0f;
}

.map-search-row{
    display: grid;
    grid-template-columns: 1fr auto;
    gap: 0.75rem;
    align-items: center;
}

.map-search-row input{
    margin: 0;
}

.map-search-note{
    margin-top: 0.6rem;
    color: #888;
    font-size: 0.9rem;
}

/* State Jump UI */
.state-jump {
    margin-bottom: 1rem;
    padding: 1rem;
    border-radius: 10px;
    border: 1px solid #222;
    background: #0f0f0f;
}

.state-jump-row {
    display: grid;
    grid-template-columns: 180px 1fr auto auto;
    gap: 0.75rem;
    align-items: center;
}

.state-jump-row label {
    margin: 0;
    font-size: 0.95rem;
}

.state-jump-row select {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #222;
    border-radius: 8px;
    background: #0a0a0a;
    color: #e0e0e0;
    font-size: 1rem;
}

.state-jump-row select:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
}

.state-jump-note {
    margin-top: 0.75rem;
    color: #888;
    font-size: 0.9rem;
    text-align: left;
}

/* Form Styles */
.form-group {
    margin-bottom: 1.5rem;
}

label {
    display: block;
    color: #00ff88;
    font-weight: 600;
    margin-bottom: 0.5rem;
}

input, textarea {
    width: 100%;
    padding: 0.75rem;
    border: 2px solid #222;
    border-radius: 8px;
    background: #0a0a0a;
    color: #e0e0e0;
    font-size: 1rem;
    transition: border-color 0.3s ease;
}

input:focus, textarea:focus {
    outline: none;
    border-color: #00ff88;
    box-shadow: 0 0 10px rgba(0, 255, 136, 0.2);
}

input::placeholder, textarea::placeholder {
    color: #666;
}

.form-row {
    display: grid;
    grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
    gap: 1rem;
}

.radio-group {
    display: flex;
    gap: 2rem;
    margin-top: 0.5rem;
}

.radio-group label {
    display: flex;
    align-items: center;
    gap: 0.5rem;
    color: #e0e0e0;
    font-weight: normal;
    cursor: pointer;
}

.radio-group input[type="radio"] {
    width: auto;
    margin: 0;
}

.btn-primary {
    background: #00ff88;
    color: #0a0a0a;
    border: none;
    padding: 1rem 2rem;
    border-radius: 8px;
    font-size: 1.1rem;
    font-weight: 700;
    cursor: pointer;
    transition: all 0.3s ease;
    width: 100%;
}

.btn-primary:hover {
    background: #00cc66;
    transform: translateY(-2px);
    box-shadow: 0 4px 15px rgba(0, 255, 136, 0.3);
}

.btn-secondary {
    background: transparent;
    color: #00ff88;
    border: 2px solid #00ff88;
    padding: 0.75rem 1.5rem;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 600;
    transition: all 0.3s ease;
}

.btn-secondary:hover {
    background: #00ff88;
    color: #0a0a0a;
}

.form-note {
    color: #888;
    font-size: 0.9rem;
    margin-top: 1rem;
    text-align: center;
    font-style: italic;
}

/* Subscription Section */
.subscription-section p {
    color: #b0b0b0;
    margin-bottom: 1.5rem;
}

.privacy-note {
    color: #666;
    font-size: 0.85rem;
    margin-top: 0.5rem;
    text-align: center;
}

/* Footer */
footer {
    background: #111;
    padding: 2rem 0;
    text-align: center;
    border-top: 2px solid #222;
    margin-top: 3rem;
}

footer p {
    color: #666;
}

/* Alert Messages */
.alert {
    padding: 1rem;
    border-radius: 8px;
    margin-bottom: 1rem;
    font-weight: 600;
}

.alert-success {
    background: rgba(0, 255, 136, 0.1);
    border: 1px solid #00ff88;
    color: #00ff88;
}

.alert-error {
    background: rgba(255, 68, 68, 0.1);
    border: 1px solid #ff4444;
    color: #ff4444;
}

/* Monkey Mode Styles */
.map-menu {
    position: absolute;
    top: 10px;
    left: 10px;
    z-index: 1000;
}

.monkey-mode-btn {
    background: rgba(0, 0, 0, 0.8);
    color: #00ff88;
    border: 2px solid #00ff88;
    padding: 8px 12px;
    border-radius: 8px;
    cursor: pointer;
    font-weight: 700;
    transition: all 0.3s ease;
}

.monkey-mode-btn:hover {
    background: rgba(0, 255, 136, 0.15);
}

#monkey-controls {
    background: #0f0f0f;
    border: 2px solid #00ff88;
    border-radius: 10px;
    padding: 1rem;
    margin-top: 1rem;
}

#monkey-info {
    margin-bottom: 1rem;
}

#monkey-counter {
    color: #00ff88;
    font-weight: 800;
}

.monkey-instruction {
    color: #b0b0b0;
    font-size: 0.95rem;
}

#rotation-indicator {
    background: rgba(0, 255, 136, 0.12);
    border: 1px solid #00ff88;
    padding: 0.5rem 0.75rem;
    border-radius: 8px;
    margin-bottom: 0.75rem;
    color: #00ff88;
    font-weight: 700;
}

@media (max-width: 768px) {
    header h1 {
        font-size: 2.2rem;
    }

    .radio-group {
        flex-direction: column;
        gap: 1rem;
    }

    section {
        padding: 1.5rem;
    }

    #map {
        height: 400px;
    }

    .state-jump-row {
        grid-template-columns: 1fr;
    }
}
/* Custom stacked map controls (Monkey -> Zoom -> My Location) */
.leaflet-control.custom-map-controls {
    background: transparent;
    border: none;
    box-shadow: none;
    margin-top: 10px;
    margin-left: 10px;
}

.custom-map-controls .ctrl-stack {
    display: flex;
    flex-direction: column;
    gap: 8px;
}

/* Make buttons match your theme */
.custom-map-controls .ctrl-btn {
    width: 160px;
    text-align: left;
    background: rgba(0, 0, 0, 0.85);
    color: #00ff88;
    border: 2px solid #00ff88;
    padding: 8px 12px;
    border-radius: 10px;
    cursor: pointer;
    font-weight: 800;
    transition: all 0.3s ease;
}

.custom-map-controls .ctrl-btn:hover {
    background: rgba(0, 255, 136, 0.15);
}

.custom-map-controls .ctrl-btn:disabled {
    opacity: 0.6;
    cursor: not-allowed;
}

/* Zoom buttons smaller + centered */
.custom-map-controls .zoom-row {
    display: flex;
    gap: 8px;
}

.custom-map-controls .zoom-btn {
    width: 76px;
    text-align: center;
}

</style>
</head>
<body>
    <header>
        <div class="container">
            <h1>ü¶å Deer Tracker</h1>
            <p>Real-time deer sighting locations</p>
        </div>
    </header>

    <main class="container">
        <!-- Map Section -->
        <section class="map-section">
            <h2>Live Deer Locations</h2>

            <!-- State Jump (no GPS needed) -->
            <div class="state-jump">
                <div class="state-jump-row">
                    <label for="state-jump-select">Jump to a state:</label>
                    <select id="state-jump-select">
                        <option value="">Select a state‚Ä¶</option>
                    </select>
                    <button type="button" id="state-jump-btn" class="btn-secondary">Go</button>
                    <button type="button" id="state-reset-btn" class="btn-secondary">Reset</button>
                </div>
                <p class="state-jump-note">
                    If you don‚Äôt want to share location, choose a state and the map will zoom there.
                </p>
            </div>

           <!-- Zip search (US-only) -->
<div class="map-search">
    <div class="map-search-row">
        <input
            type="text"
            id="zip-input"
            inputmode="numeric"
            autocomplete="postal-code"
            placeholder="Enter US Zip Code (e.g., 33101)"
            maxlength="10"
        />
        <button type="button" id="zip-go-btn" class="btn-secondary">Go</button>
    </div>
    <p class="map-search-note">Tip: If you don‚Äôt want to share GPS, enter a US zip code to jump the map.</p>
</div>

<div style="position: relative;">
    <div id="map"></div>

<!-- Map controls are now built as a Leaflet control (Monkey + Zoom + My Location) -->

</div>


            <!-- Monkey Mode Controls (Below Map, Hidden by Default) -->
            <div id="monkey-controls" style="display: none;">
    <div id="rotation-indicator" style="display: none;"></div>
    <div id="monkey-info">
        <p id="monkey-counter">Monkeys Added: 0/5</p>
        <p class="monkey-instruction">Click map to add monkeys. Click monkeys to rotate direction.</p>
    </div>

    <!-- NEW: Monkey list preview (lat/lng + city/state) -->
    <div id="monkey-list" style="margin-bottom: 1rem;"></div>

    <form id="monkey-form">
    <div class="form-group">
                        <label for="monkey-name">Your Name (Optional):</label>
                        <input type="text" id="monkey-name" placeholder="John Doe">
                    </div>

                    <div class="form-group">
                        <label for="monkey-email">Your Email (Optional):</label>
                        <input type="email" id="monkey-email" placeholder="your@email.com">
                    </div>

                    <div class="form-group">
                        <label for="monkey-notes">Notes (Optional):</label>
                        <textarea id="monkey-notes" rows="3" placeholder="Details about the monkeys..."></textarea>
                    </div>

                    <button type="button" id="submit-monkeys-btn" class="btn-primary">Submit All Monkeys</button>
                    <button type="button" id="cancel-monkey-btn" class="btn-secondary">Cancel</button>
                </form>
            </div>

            <p class="map-info">Click on the map to add a sighting, or use the form below</p>
        </section>

        <!-- Regular Deer Sighting Form -->
        <section class="form-section" id="regular-form">
            <h2>Report a Deer Sighting</h2>
            <form id="sighting-form">
                <div class="form-group">
                    <label>Location Method:</label>
                    <div class="radio-group">
                        <label>
                            <input type="radio" name="location-method" value="map" checked>
                            Click on Map
                        </label>
                        <label>
                            <input type="radio" name="location-method" value="address">
                            Enter Address
                        </label>
                    </div>
                </div>

                <div id="address-fields" style="display: none;">
                    <div class="form-group">
                        <label for="street">Street Address (Optional):</label>
                        <input type="text" id="street" placeholder="123 Main St">
                    </div>
                    <div class="form-row">
                        <div class="form-group">
                            <label for="city">City:</label>
                            <input type="text" id="city" placeholder="Miami">
                        </div>
                        <div class="form-group">
                            <label for="state">State:</label>
                            <input type="text" id="state" placeholder="FL" maxlength="2">
                        </div>
                        <div class="form-group">
                            <label for="zip">Zip Code (Optional):</label>
                            <input type="text" id="zip" placeholder="33101">
                        </div>
                    </div>
                    <button type="button" id="geocode-btn" class="btn-secondary">Find Location</button>
                </div>

                <div id="map-location" style="display: none;">
                    <p><strong>Selected Location:</strong></p>
                    <p id="selected-coords">Click on the map to select a location</p>
                </div>

                <div class="form-group">
                    <label for="hunter-name">Your Name (Optional):</label>
                    <input type="text" id="hunter-name" placeholder="John Doe">
                </div>

                <div class="form-group">
                    <label for="hunter-email">Your Email (Optional):</label>
                    <input type="email" id="hunter-email" placeholder="your@email.com">
                </div>

                <div class="form-group">
                    <label for="notes">Notes (Optional):</label>
                    <textarea id="notes" rows="3" placeholder="Big buck, 8 points, near oak tree..."></textarea>
                </div>

                <button type="submit" class="btn-primary" id="submit-btn">Submit Sighting</button>
                <p class="form-note">Your submission will be reviewed before appearing on the map</p>
            </form>
        </section>

        <!-- Email Subscription -->
        <section class="subscription-section">
            <h2>Get Notified of New Deer Sightings</h2>
            <p>Enter your email to receive notifications when new deer are spotted</p>
            <form id="subscribe-form">
                <div class="form-row">
                    <input type="email" id="subscriber-email" placeholder="your@email.com" required>
                    <button type="submit" class="btn-primary">Subscribe</button>
                </div>
                <p class="privacy-note">We respect your privacy. Your email will never be shared.</p>
            </form>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2026 Deer Tracker</p>
        </div>
    </footer>

    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

    <script type="module">
import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

const SUPABASE_URL = 'https://mtulnhypiozhjltbkzwo.supabase.co';
const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im10dWxuaHlwaW96aGpsdGJrendvIiwicm9sZSI6ImFub24iLCJpYXQiOjE3Njk3MTY1NzMsImV4cCI6MjA4NTI5MjU3M30.LY2JEaZ95XcIvXtzWJYqD14vL4gDzTY5a717b_jYCrI';

const sb = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);

const MAX_MONKEYS = 5;

let map;
let selectedLatLng = null;
let monkeyMode = false;

let userMarker = null;
let lastUserLatLng = null;

let monkeyMarkers = [];
let currentRotation = 0;
let currentMonkeyIndex = 0;

const greenIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-green.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

const redIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-red.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});

const blueIcon = new L.Icon({
    iconUrl: 'https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-2x-blue.png',
    shadowUrl: 'https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png',
    iconSize: [25, 41],
    iconAnchor: [12, 41],
    popupAnchor: [1, -34],
    shadowSize: [41, 41]
});
const US_STATE_TO_ABBR = {
  "alabama":"AL","alaska":"AK","arizona":"AZ","arkansas":"AR","california":"CA","colorado":"CO","connecticut":"CT",
  "delaware":"DE","florida":"FL","georgia":"GA","hawaii":"HI","idaho":"ID","illinois":"IL","indiana":"IN","iowa":"IA",
  "kansas":"KS","kentucky":"KY","louisiana":"LA","maine":"ME","maryland":"MD","massachusetts":"MA","michigan":"MI",
  "minnesota":"MN","mississippi":"MS","missouri":"MO","montana":"MT","nebraska":"NE","nevada":"NV","new hampshire":"NH",
  "new jersey":"NJ","new mexico":"NM","new york":"NY","north carolina":"NC","north dakota":"ND","ohio":"OH","oklahoma":"OK",
  "oregon":"OR","pennsylvania":"PA","rhode island":"RI","south carolina":"SC","south dakota":"SD","tennessee":"TN","texas":"TX",
  "utah":"UT","vermont":"VT","virginia":"VA","washington":"WA","west virginia":"WV","wisconsin":"WI","wyoming":"WY",
  "district of columbia":"DC"
};

function normalizeStateAbbr(stateText) {
  if (!stateText) return null;
  const s = String(stateText).trim();
  if (!s) return null;
  if (s.length === 2) return s.toUpperCase();
  const key = s.toLowerCase();
  return US_STATE_TO_ABBR[key] || s.toUpperCase();
}

async function reverseGeocodeUS(lat, lng) {
  const url = `https://nominatim.openstreetmap.org/reverse?format=json&lat=${encodeURIComponent(lat)}&lon=${encodeURIComponent(lng)}&addressdetails=1`;

  const res = await fetch(url, {
    headers: {
      'Accept': 'application/json'
    }
  });

  if (!res.ok) {
    const txt = await res.text().catch(() => '');
    throw new Error(`reverse geocode failed (${res.status}) ${txt}`.trim());
  }

  const json = await res.json();

  const addr = json.address || {};
  const city =
    addr.city || addr.town || addr.village || addr.hamlet || addr.county || null;

  const stateAbbr = normalizeStateAbbr(addr.state || addr.region || null);
  const zip = addr.postcode ? String(addr.postcode).trim() : null;

  return {
    city: city ? String(city).trim() : null,
    state: stateAbbr || null,
    zip_code: zip || null
  };
}

/**
 * State centers (approx). Privacy-first: no GPS required.
 */
const STATE_CENTERS = {
  "AL": { name: "Alabama", lat: 32.806671, lng: -86.79113, zoom: 7 },
  "AK": { name: "Alaska", lat: 61.370716, lng: -152.404419, zoom: 4 },
  "AZ": { name: "Arizona", lat: 33.729759, lng: -111.431221, zoom: 7 },
  "AR": { name: "Arkansas", lat: 34.969704, lng: -92.373123, zoom: 7 },
  "CA": { name: "California", lat: 36.116203, lng: -119.681564, zoom: 6 },
  "CO": { name: "Colorado", lat: 39.059811, lng: -105.311104, zoom: 7 },
  "CT": { name: "Connecticut", lat: 41.597782, lng: -72.755371, zoom: 8 },
  "DE": { name: "Delaware", lat: 39.318523, lng: -75.507141, zoom: 8 },
  "FL": { name: "Florida", lat: 27.766279, lng: -81.686783, zoom: 7 },
  "GA": { name: "Georgia", lat: 33.040619, lng: -83.643074, zoom: 7 },
  "HI": { name: "Hawaii", lat: 21.094318, lng: -157.498337, zoom: 7 },
  "ID": { name: "Idaho", lat: 44.240459, lng: -114.478828, zoom: 6 },
  "IL": { name: "Illinois", lat: 40.349457, lng: -88.986137, zoom: 7 },
  "IN": { name: "Indiana", lat: 39.849426, lng: -86.258278, zoom: 7 },
  "IA": { name: "Iowa", lat: 42.011539, lng: -93.210526, zoom: 7 },
  "KS": { name: "Kansas", lat: 38.5266, lng: -96.726486, zoom: 7 },
  "KY": { name: "Kentucky", lat: 37.66814, lng: -84.670067, zoom: 7 },
  "LA": { name: "Louisiana", lat: 31.169546, lng: -91.867805, zoom: 7 },
  "ME": { name: "Maine", lat: 44.693947, lng: -69.381927, zoom: 7 },
  "MD": { name: "Maryland", lat: 39.063946, lng: -76.802101, zoom: 7 },
  "MA": { name: "Massachusetts", lat: 42.230171, lng: -71.530106, zoom: 8 },
  "MI": { name: "Michigan", lat: 43.326618, lng: -84.536095, zoom: 6 },
  "MN": { name: "Minnesota", lat: 45.694454, lng: -93.900192, zoom: 6 },
  "MS": { name: "Mississippi", lat: 32.741646, lng: -89.678696, zoom: 7 },
  "MO": { name: "Missouri", lat: 38.456085, lng: -92.288368, zoom: 7 },
  "MT": { name: "Montana", lat: 46.921925, lng: -110.454353, zoom: 6 },
  "NE": { name: "Nebraska", lat: 41.12537, lng: -98.268082, zoom: 7 },
  "NV": { name: "Nevada", lat: 38.313515, lng: -117.055374, zoom: 6 },
  "NH": { name: "New Hampshire", lat: 43.452492, lng: -71.563896, zoom: 8 },
  "NJ": { name: "New Jersey", lat: 40.298904, lng: -74.521011, zoom: 8 },
  "NM": { name: "New Mexico", lat: 34.840515, lng: -106.248482, zoom: 7 },
  "NY": { name: "New York", lat: 42.165726, lng: -74.948051, zoom: 7 },
  "NC": { name: "North Carolina", lat: 35.630066, lng: -79.806419, zoom: 7 },
  "ND": { name: "North Dakota", lat: 47.528912, lng: -99.784012, zoom: 7 },
  "OH": { name: "Ohio", lat: 40.388783, lng: -82.764915, zoom: 7 },
  "OK": { name: "Oklahoma", lat: 35.565342, lng: -96.928917, zoom: 7 },
  "OR": { name: "Oregon", lat: 44.572021, lng: -122.070938, zoom: 6 },
  "PA": { name: "Pennsylvania", lat: 40.590752, lng: -77.209755, zoom: 7 },
  "RI": { name: "Rhode Island", lat: 41.680893, lng: -71.51178, zoom: 9 },
  "SC": { name: "South Carolina", lat: 33.856892, lng: -80.945007, zoom: 7 },
  "SD": { name: "South Dakota", lat: 44.299782, lng: -99.438828, zoom: 7 },
  "TN": { name: "Tennessee", lat: 35.747845, lng: -86.692345, zoom: 7 },
  "TX": { name: "Texas", lat: 31.054487, lng: -97.563461, zoom: 6 },
  "UT": { name: "Utah", lat: 40.150032, lng: -111.862434, zoom: 7 },
  "VT": { name: "Vermont", lat: 44.045876, lng: -72.710686, zoom: 8 },
  "VA": { name: "Virginia", lat: 37.769337, lng: -78.169968, zoom: 7 },
  "WA": { name: "Washington", lat: 47.400902, lng: -121.490494, zoom: 6 },
  "WV": { name: "West Virginia", lat: 38.491226, lng: -80.954453, zoom: 7 },
  "WI": { name: "Wisconsin", lat: 44.268543, lng: -89.616508, zoom: 7 },
  "WY": { name: "Wyoming", lat: 42.755966, lng: -107.30249, zoom: 7 },
  "DC": { name: "District of Columbia", lat: 38.9072, lng: -77.0369, zoom: 10 }
};

const DEFAULT_VIEW = { lat: 39.8283, lng: -98.5795, zoom: 4 };

function populateStateDropdown() {
  const sel = document.getElementById('state-jump-select');
  if (!sel) return;

  const entries = Object.entries(STATE_CENTERS)
    .sort((a, b) => a[1].name.localeCompare(b[1].name));

  entries.forEach(([code, info]) => {
    const opt = document.createElement('option');
    opt.value = code;
    opt.textContent = `${info.name} (${code})`;
    sel.appendChild(opt);
  });
}

function jumpToState(code) {
  const info = STATE_CENTERS[code];
  if (!info || !map) return;
  map.setView([info.lat, info.lng], info.zoom);
  showMessage(`Map moved to ${info.name}.`, 'success');
}

function confirmSubmit(title, bodyLines){
  const body = bodyLines.filter(Boolean).join("\n");
  const ok = window.confirm(`${title}\n\n${body}\n\nPress OK to submit, or Cancel to go back.`);
  return ok;
}

function showMessage(message, type = 'success') {
    const existingAlert = document.querySelector('.alert');
    if (existingAlert) {
        existingAlert.remove();
    }

    const alert = document.createElement('div');
    alert.className = `alert alert-${type}`;
    alert.textContent = message;

    const main = document.querySelector('main');
    main.insertBefore(alert, main.firstChild);

    setTimeout(() => {
        if (alert.parentNode) {
            alert.remove();
        }
    }, 5000);
}
function isValidUsZip(zipRaw){
    const zip = zipRaw.trim();
    return /^\d{5}(-\d{4})?$/.test(zip);
}

async function goToZip(zipRaw){
    const zip = zipRaw.trim();

    if (!isValidUsZip(zip)){
        showMessage('Please enter a valid US zip code (e.g., 33101 or 33101-1234).', 'error');
        return;
    }

    const btn = document.getElementById('zip-go-btn');
    const input = document.getElementById('zip-input');

    try {
        btn.disabled = true;
        btn.textContent = 'Searching...';

        // Try postalcode endpoint first (US only)
        const url1 = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&postalcode=${encodeURIComponent(zip)}&limit=1`;
        let res = await fetch(url1, { headers: { 'Accept': 'application/json' } });
        let data = await res.json();

        // Fallback: generic query if postalcode returns empty
        if (!Array.isArray(data) || data.length === 0){
            const url2 = `https://nominatim.openstreetmap.org/search?format=json&countrycodes=us&q=${encodeURIComponent(zip)}&limit=1`;
            res = await fetch(url2, { headers: { 'Accept': 'application/json' } });
            data = await res.json();
        }

        if (!Array.isArray(data) || data.length === 0){
            showMessage('Zip code not found. Try a different zip.', 'error');
            return;
        }

        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);

        if (!Number.isFinite(lat) || !Number.isFinite(lon)){
            showMessage('Zip code lookup returned an invalid location. Try again.', 'error');
            return;
        }

        map.setView([lat, lon], 12);
        showMessage(`Map moved to zip code ${zip}.`, 'success');

        // Optional: close keyboard on mobile
        input.blur();

    } catch (err){
        console.error('Zip geocode error:', err);
        showMessage('Error looking up zip code. Please try again.', 'error');
    } finally {
        btn.disabled = false;
        btn.textContent = 'Go';
    }
}
function centerOnUserLocation() {
    if (!navigator.geolocation) {
        showMessage('Geolocation not available on this device.', 'error');
        return;
    }

    navigator.geolocation.getCurrentPosition(
        (position) => {
            const userLat = position.coords.latitude;
            const userLng = position.coords.longitude;

            lastUserLatLng = { lat: userLat, lng: userLng };

            map.setView([userLat, userLng], 14);

            if (userMarker) {
                userMarker.setLatLng([userLat, userLng]);
            } else {
                userMarker = L.marker([userLat, userLng], { icon: blueIcon })
                    .addTo(map)
                    .bindPopup('Your Location');
            }
        },
        () => {
            showMessage('Location not shared. Use the state dropdown or zip search.', 'success');
        }
    );
}

function initMap() {
    // Disable default zoom control so it doesn't overlap anything
    map = L.map('map', { zoomControl: false }).setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
        attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add custom stacked control: Monkey Mode -> Zoom -> My Location
    const CustomControls = L.Control.extend({
        options: { position: 'topleft' },
        onAdd: function () {
            const container = L.DomUtil.create('div', 'leaflet-control custom-map-controls');
            const stack = L.DomUtil.create('div', 'ctrl-stack', container);

            // Monkey Mode button (same id so your existing listeners keep working)
            const monkeyBtn = L.DomUtil.create('button', 'ctrl-btn', stack);
            monkeyBtn.id = 'monkey-mode-btn';
            monkeyBtn.type = 'button';
            monkeyBtn.textContent = 'üêµ Monkey Mode';

            // Zoom + / -
            const zoomRow = L.DomUtil.create('div', 'zoom-row', stack);

            const zoomIn = L.DomUtil.create('button', 'ctrl-btn zoom-btn', zoomRow);
            zoomIn.type = 'button';
            zoomIn.textContent = 'Ôºã';

            const zoomOut = L.DomUtil.create('button', 'ctrl-btn zoom-btn', zoomRow);
            zoomOut.type = 'button';
            zoomOut.textContent = 'Ôºç';

            // My Location button
            const locBtn = L.DomUtil.create('button', 'ctrl-btn', stack);
            locBtn.id = 'my-location-btn';
            locBtn.type = 'button';
            locBtn.textContent = 'üìç My Location';

            // Prevent map drag/zoom when clicking buttons
            L.DomEvent.disableClickPropagation(container);
            L.DomEvent.disableScrollPropagation(container);

            // Wire zoom buttons
            L.DomEvent.on(zoomIn, 'click', (e) => {
                L.DomEvent.stop(e);
                map.zoomIn();
            });

            L.DomEvent.on(zoomOut, 'click', (e) => {
                L.DomEvent.stop(e);
                map.zoomOut();
            });

            // Wire location button
            L.DomEvent.on(locBtn, 'click', (e) => {
                L.DomEvent.stop(e);
                centerOnUserLocation();
            });

            return container;
        }
    });

    map.addControl(new CustomControls());

    // Initial attempt to center on user (same behavior as before, but reusable)
    centerOnUserLocation();

    map.on('click', handleMapClick);

    loadDeerSightings();
    setupRealtimeUpdates();
}


function setupRealtimeUpdates() {
    sb
        .channel('deer_sightings_changes')
        .on('postgres_changes',
            { event: '*', schema: 'public', table: 'deer_sightings' },
            () => {
                loadDeerSightings();
            }
        )
        .subscribe();
}

async function loadDeerSightings() {
    try {
        const { data, error } = await sb
            .from('deer_sightings')
            .select('*')
            .eq('is_active', true)
            .order('sighting_time', { ascending: false });

        if (error) throw error;

        // Clear existing sighting markers (but keep user location and monkey markers)
        map.eachLayer((layer) => {
            if (layer instanceof L.Marker && layer.options.icon === greenIcon) {
                map.removeLayer(layer);
            }
        });

        data.forEach(sighting => {
            const marker = L.marker([sighting.latitude, sighting.longitude], { icon: greenIcon })
                .addTo(map);

            const popupContent = `
                <div style="color: #000;">
                    <strong>ü¶å Deer Sighting</strong><br>
                    ${sighting.city ? `${sighting.city}, ${sighting.state}` : 'Location reported'}<br>
                    ${sighting.hunter_name ? `Reported by: ${sighting.hunter_name}<br>` : ''}
                    ${sighting.notes ? `Notes: ${sighting.notes}<br>` : ''}
                    <small>${new Date(sighting.sighting_time).toLocaleString()}</small>
                </div>
            `;

            marker.bindPopup(popupContent);
        });

    } catch (error) {
        console.error('Error loading deer sightings:', error);
        showMessage('Error loading deer sightings', 'error');
    }
}
function renderMonkeyList() {
    const host = document.getElementById('monkey-list');
    if (!host) return;

    if (!monkeyMarkers || monkeyMarkers.length === 0) {
        host.innerHTML = '';
        return;
    }

    const rows = monkeyMarkers.map((m, idx) => {
        const md = m.monkeyData || {};
        const lat = Number(md.lat);
        const lng = Number(md.lng);

        const latTxt = Number.isFinite(lat) ? lat.toFixed(6) : '';
        const lngTxt = Number.isFinite(lng) ? lng.toFixed(6) : '';

        const city = md.city ? md.city : '(loading...)';
        const state = md.state ? md.state : '';
        const zip = md.zip_code ? md.zip_code : '';

        const place = (md.city && md.state)
            ? `${md.city}, ${md.state}${zip ? ' ' + zip : ''}`
            : city; // shows (loading...) or (unknown) etc

        return `
            <tr>
                <td style="padding:8px;border-bottom:1px solid #222;color:#00ff88;font-weight:700;">#${idx + 1}</td>
                <td style="padding:8px;border-bottom:1px solid #222;">${latTxt}, ${lngTxt}</td>
                <td style="padding:8px;border-bottom:1px solid #222;">${place}</td>
                <td style="padding:8px;border-bottom:1px solid #222;">${(md.direction ?? 0)}¬∞</td>
            </tr>
        `;
    }).join('');

    host.innerHTML = `
        <div style="border:1px solid #222;border-radius:10px;overflow:hidden;">
            <div style="padding:10px 12px;background:#0a0a0a;border-bottom:1px solid #222;color:#00ff88;font-weight:800;">
                Monkeys Added (preview)
            </div>
            <div style="overflow:auto;">
                <table style="width:100%;border-collapse:collapse;">
                    <thead>
                        <tr>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #222;color:#b0b0b0;font-weight:700;">#</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #222;color:#b0b0b0;font-weight:700;">Lat/Lng</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #222;color:#b0b0b0;font-weight:700;">City/State</th>
                            <th style="text-align:left;padding:8px;border-bottom:1px solid #222;color:#b0b0b0;font-weight:700;">Dir</th>
                        </tr>
                    </thead>
                    <tbody>${rows}</tbody>
                </table>
            </div>
            <div style="padding:10px 12px;background:#0f0f0f;color:#888;font-size:0.9rem;">
                If City/State stays ‚Äú(loading...)‚Äù, reverse-geocode is failing (check Console + Network).
            </div>
        </div>
    `;
}

function handleMapClick(e) {
    if (monkeyMode) {
        handleMonkeyMapClick(e);
    } else {
        handleDeerMapClick(e);
    }
}

function handleDeerMapClick(e) {
    selectedLatLng = e.latlng;

    const coordsDisplay = document.getElementById('selected-coords');
    const mapLocation = document.getElementById('map-location');

    coordsDisplay.textContent = `Looking up location... (${selectedLatLng.lat.toFixed(6)}, ${selectedLatLng.lng.toFixed(6)})`;
    mapLocation.style.display = 'block';

    reverseGeocodeUS(selectedLatLng.lat, selectedLatLng.lng)
        .then((loc) => {
            selectedLatLng = { ...selectedLatLng, ...loc };

            const place = [
                loc.city ? loc.city : null,
                loc.state ? loc.state : null,
                loc.zip_code ? loc.zip_code : null
            ].filter(Boolean).join(', ');

            coordsDisplay.textContent =
                `${place || 'Location reported'} (Lat: ${selectedLatLng.lat.toFixed(6)}, Lng: ${selectedLatLng.lng.toFixed(6)})`;
        })
        .catch(() => {
            coordsDisplay.textContent = `Lat: ${selectedLatLng.lat.toFixed(6)}, Lng: ${selectedLatLng.lng.toFixed(6)}`;
        });
}


function toggleMonkeyMode() {
    monkeyMode = !monkeyMode;

    const btn = document.getElementById('monkey-mode-btn');
    const controls = document.getElementById('monkey-controls');
    const regularForm = document.getElementById('regular-form');

    if (monkeyMode) {
        btn.textContent = 'üêµ Exit Monkey Mode';
        btn.style.background = '#00ff88';
        btn.style.color = '#000';
        controls.style.display = 'block';
        regularForm.style.display = 'none';

        resetMonkeyMode();
        showMessage('Monkey Mode activated! Click map to add monkeys.', 'success');
    } else {
        btn.textContent = 'üêµ Monkey Mode';
        btn.style.background = 'rgba(0, 0, 0, 0.8)';
        btn.style.color = '#00ff88';
        controls.style.display = 'none';
        regularForm.style.display = 'block';

        clearMonkeyMarkers();
        showMessage('Monkey Mode deactivated', 'success');
    }
}

function resetMonkeyMode() {
    monkeyMarkers = [];
    currentMonkeyIndex = 0;
    currentRotation = 0;
    updateMonkeyCounter();
    document.getElementById('rotation-indicator').style.display = 'none';
}

function updateMonkeyCounter() {
    const counter = document.getElementById('monkey-counter');
    counter.textContent = `Monkeys Added: ${monkeyMarkers.length}/${MAX_MONKEYS}`;
}

function clearMonkeyMarkers() {
    monkeyMarkers.forEach(marker => map.removeLayer(marker));
    monkeyMarkers = [];
}

function handleMonkeyMapClick(e) {
    if (monkeyMarkers.length >= MAX_MONKEYS) {
        showMessage('Maximum 5 monkeys allowed per session!', 'error');
        return;
    }

    const monkeyNumber = monkeyMarkers.length + 1;
    const marker = L.marker(e.latlng, { icon: redIcon }).addTo(map);

    marker.monkeyData = {
        lat: e.latlng.lat,
        lng: e.latlng.lng,
        direction: 0,
        number: monkeyNumber,
        city: null,
        state: null,
        zip_code: null
    };

        marker.bindPopup(`
        <div style="color: #000;">
            <strong>üêµ Monkey #${monkeyNumber}</strong><br>
            Location: <span class="monkey-place">(loading...)</span><br>
            Direction: <span class="direction-display">0¬∞</span><br>
            <small>Click marker to rotate direction</small>
        </div>
    `);

    marker.on('click', () => rotateMonkeyDirection(marker));

    monkeyMarkers.push(marker);
    updateMonkeyCounter();
    renderMonkeyList();

    reverseGeocodeUS(marker.monkeyData.lat, marker.monkeyData.lng)
        .then((loc) => {
            marker.monkeyData.city = loc.city || null;
            marker.monkeyData.state = loc.state || null;
            marker.monkeyData.zip_code = loc.zip_code || null;

            // Update popup text too
            const popup = marker.getPopup();
            if (popup) {
                const place = (marker.monkeyData.city && marker.monkeyData.state)
                    ? `${marker.monkeyData.city}, ${marker.monkeyData.state}${marker.monkeyData.zip_code ? ' ' + marker.monkeyData.zip_code : ''}`
                    : '(unknown)';

                const content = popup.getContent();
                const updated = content.replace(
                    /Location:\s*<span class="monkey-place">.*?<\/span>/,
                    `Location: <span class="monkey-place">${place}</span>`
                );
                popup.setContent(updated);
            }

            renderMonkeyList();
        })
        .catch((err) => {
            console.error('Monkey reverse geocode failed:', err);
            // Show in list as unknown instead of loading forever
            marker.monkeyData.city = '(unknown)';
            marker.monkeyData.state = null;
            marker.monkeyData.zip_code = null;
            renderMonkeyList();
        });

    showRotationIndicator(monkeyNumber);
    showMessage(`Monkey #${monkeyNumber} added! Click it to rotate direction.`, 'success');
}


function showRotationIndicator(monkeyNumber) {
    const indicator = document.getElementById('rotation-indicator');
    indicator.style.display = 'block';
    indicator.textContent = `Click Monkey #${monkeyNumber} to rotate direction`;
}

function rotateMonkeyDirection(marker) {
    marker.monkeyData.direction = (marker.monkeyData.direction + 45) % 360;

    const popup = marker.getPopup();
    if (popup) {
        const content = popup.getContent();
        const updatedContent = content.replace(/Direction: <span class="direction-display">.*?<\/span>/,
            `Direction: <span class="direction-display">${marker.monkeyData.direction}¬∞</span>`);
        popup.setContent(updatedContent);
    }

    showMessage(`Monkey #${marker.monkeyData.number} direction: ${marker.monkeyData.direction}¬∞`, 'success');
}

function setupForms() {
    // Location method toggle
    const locationRadios = document.querySelectorAll('input[name="location-method"]');
    const addressFields = document.getElementById('address-fields');

    locationRadios.forEach(radio => {
        radio.addEventListener('change', (e) => {
            addressFields.style.display = e.target.value === 'address' ? 'block' : 'none';
        });
    });

    // Deer sighting form submit
    document.getElementById('sighting-form').addEventListener('submit', handleSightingSubmit);

    // Subscription form submit
    document.getElementById('subscribe-form').addEventListener('submit', handleSubscriptionSubmit);

    // Monkey mode buttons
    document.getElementById('monkey-mode-btn').addEventListener('click', toggleMonkeyMode);
    document.getElementById('submit-monkeys-btn').addEventListener('click', handleMonkeySubmit);
    document.getElementById('cancel-monkey-btn').addEventListener('click', () => {
        toggleMonkeyMode();
    });

  // Geocode button (address mode)
document.getElementById('geocode-btn').addEventListener('click', handleGeocode);

// Zip search (US-only)
document.getElementById('zip-go-btn').addEventListener('click', () => {
    const zip = document.getElementById('zip-input').value;
    goToZip(zip);
});

document.getElementById('zip-input').addEventListener('keydown', (e) => {
    if (e.key === 'Enter'){
        e.preventDefault();
        const zip = document.getElementById('zip-input').value;
        goToZip(zip);
    }
});

    // State Jump controls
    populateStateDropdown();

    const goBtn = document.getElementById('state-jump-btn');
    const resetBtn = document.getElementById('state-reset-btn');
    const sel = document.getElementById('state-jump-select');

    if (goBtn && sel) {
        goBtn.addEventListener('click', () => {
            if (!sel.value) {
                showMessage('Please select a state first.', 'error');
                return;
            }
            jumpToState(sel.value);
        });

        sel.addEventListener('change', () => {
            if (sel.value) jumpToState(sel.value);
        });
    }

    if (resetBtn) {
        resetBtn.addEventListener('click', () => {
            if (!map) return;
            map.setView([DEFAULT_VIEW.lat, DEFAULT_VIEW.lng], DEFAULT_VIEW.zoom);
            showMessage('Map reset to default view.', 'success');
        });
    }
}

async function handleSightingSubmit(e) {
    e.preventDefault();

    const formData = {
        submitter_name: document.getElementById('hunter-name').value || null,
        submitter_email: document.getElementById('hunter-email').value || null,
        notes: document.getElementById('notes').value || null,
        sighting_time: new Date().toISOString(),
        status: 'pending'
    };

    const locationMethod = document.querySelector('input[name="location-method"]:checked').value;

  if (locationMethod === 'map') {
    if (!selectedLatLng) {
        showMessage('Please click on the map to select a location first', 'error');
        return;
    }
    formData.latitude = selectedLatLng.lat;
    formData.longitude = selectedLatLng.lng;

    // NEW: auto-filled from reverse geocode on map click
    formData.city = selectedLatLng.city || null;
    formData.state = selectedLatLng.state || null;
    formData.zip_code = selectedLatLng.zip_code || null;
}
 else {
        const city = document.getElementById('city').value;
        const state = document.getElementById('state').value;

        if (!city || !state) {
            showMessage('Please enter at least city and state', 'error');
            return;
        }

        if (!selectedLatLng) {
            showMessage('Please click "Find Location" to locate the address', 'error');
            return;
        }

        formData.latitude = selectedLatLng.lat;
        formData.longitude = selectedLatLng.lng;
        formData.street_address = document.getElementById('street').value || null;
        formData.city = city;
        formData.state = state.toUpperCase();
        formData.zip_code = document.getElementById('zip').value || null;
    }

    const previewLines = [
        `Type: Deer sighting (pending review)`,
        `Location: ${formData.city && formData.state ? `${formData.city}, ${formData.state}` : 'Map coordinates'}`,
        `Latitude: ${Number(formData.latitude).toFixed(6)}`,
        `Longitude: ${Number(formData.longitude).toFixed(6)}`,
        formData.street_address ? `Street: ${formData.street_address}` : null,
        formData.zip_code ? `Zip: ${formData.zip_code}` : null,
        formData.submitter_name ? `Name: ${formData.submitter_name}` : `Name: (not provided)`,
        formData.submitter_email ? `Email: ${formData.submitter_email}` : `Email: (not provided)`,
        formData.notes ? `Notes: ${formData.notes}` : `Notes: (none)`
    ];

    const ok = confirmSubmit("Confirm Submission", previewLines);
    if (!ok) return;

    try {
        const { error } = await sb
            .from('pending_submissions')
            .insert([formData]);

        if (error) throw error;

        showMessage('Sighting submitted successfully! It will be reviewed before appearing on the map.', 'success');
        document.getElementById('sighting-form').reset();
        selectedLatLng = null;
        document.getElementById('map-location').style.display = 'none';

    } catch (error) {
        console.error('Error submitting sighting:', error);
        showMessage('Error submitting sighting. Please try again.', 'error');
    }
}

async function handleSubscriptionSubmit(e) {
    e.preventDefault();

    const email = document.getElementById('subscriber-email').value;

    try {
        const { error } = await sb
            .from('subscribers')
            .insert([{ email }]);

        if (error) throw error;

        showMessage('Successfully subscribed to notifications!', 'success');
        document.getElementById('subscribe-form').reset();

    } catch (error) {
        console.error('Error subscribing:', error);

        if (error.code === '23505') { // unique constraint
            showMessage('You are already subscribed!', 'error');
        } else {
            showMessage('Error subscribing. Please try again.', 'error');
        }
    }
}

async function handleGeocode() {
    const street = document.getElementById('street').value;
    const city = document.getElementById('city').value;
    const state = document.getElementById('state').value;
    const zip = document.getElementById('zip').value;

    if (!city || !state) {
        showMessage('Please enter at least city and state', 'error');
        return;
    }

    const address = `${street ? street + ', ' : ''}${city}, ${state} ${zip || ''}`.trim();

    try {
        const response = await fetch(`https://nominatim.openstreetmap.org/search?format=json&q=${encodeURIComponent(address)}`);
        const data = await response.json();

        if (data.length === 0) {
            showMessage('Address not found. Please check and try again.', 'error');
            return;
        }

        const lat = parseFloat(data[0].lat);
        const lon = parseFloat(data[0].lon);

        selectedLatLng = { lat, lng: lon };
        map.setView([lat, lon], 14);

        const coordsDisplay = document.getElementById('selected-coords');
        const mapLocation = document.getElementById('map-location');

        coordsDisplay.textContent = `Lat: ${lat.toFixed(6)}, Lng: ${lon.toFixed(6)}`;
        mapLocation.style.display = 'block';

        showMessage('Location found! You can now submit the sighting.', 'success');

    } catch (error) {
        console.error('Geocoding error:', error);
        showMessage('Error finding location. Please try again.', 'error');
    }
}

async function handleMonkeySubmit() {
    if (monkeyMarkers.length === 0) {
        showMessage('Please add at least one monkey on the map first!', 'error');
        return;
    }

    const sessionId = crypto.randomUUID();
    const submitterName = document.getElementById('monkey-name').value || null;
    const submitterEmail = document.getElementById('monkey-email').value || null;
    const notes = document.getElementById('monkey-notes').value || null;

    const previewLines = [
        `Type: Monkey Mode (pending review)`,
        `Monkeys: ${monkeyMarkers.length}`,
        `Session ID: ${sessionId}`,
        submitterName ? `Name: ${submitterName}` : `Name: (not provided)`,
        submitterEmail ? `Email: ${submitterEmail}` : `Email: (not provided)`,
        notes ? `Notes: ${notes}` : `Notes: (none)`,
        "",
        "Monkeys detail:"
    ];

    monkeyMarkers.forEach((m, i) => {
        previewLines.push(
            `#${i + 1} lat=${Number(m.monkeyData.lat).toFixed(6)}, lng=${Number(m.monkeyData.lng).toFixed(6)}, dir=${m.monkeyData.direction}¬∞`
        );
    });

    const ok = confirmSubmit("Confirm Monkey Submissions", previewLines);
    if (!ok) return;

// Ensure every monkey has city/state before insert (best-effort)
await Promise.all(monkeyMarkers.map(async (m) => {
    const md = m.monkeyData || {};
    const needsLoc = !md.city || !md.state || md.city === '(loading...)' || md.city === '(unknown)';
    if (!needsLoc) return;

    try {
        const loc = await reverseGeocodeUS(md.lat, md.lng);
        md.city = loc.city || null;
        md.state = loc.state || null;
        md.zip_code = loc.zip_code || null;
    } catch (err) {
        console.error('Pre-submit reverse geocode failed:', err);
        // Keep nulls if it truly fails; but now you‚Äôll see why in console/network
        md.city = md.city && md.city !== '(loading...)' ? md.city : null;
    }
}));

renderMonkeyList();

const monkeySubmissions = monkeyMarkers.map((marker, index) => ({
    latitude: marker.monkeyData.lat,
    longitude: marker.monkeyData.lng,
    city: (marker.monkeyData.city && marker.monkeyData.city !== '(unknown)') ? marker.monkeyData.city : null,
    state: marker.monkeyData.state || null,
    zip_code: marker.monkeyData.zip_code || null,
    submitter_name: submitterName,
    submitter_email: submitterEmail,
    notes: notes,
    sighting_time: new Date().toISOString(),
    status: 'pending',
    monkey_count: monkeyMarkers.length,
    monkey_direction: marker.monkeyData.direction,
    monkey_number: index + 1,
    session_id: sessionId
}));



    try {
        const { error } = await sb
            .from('pending_submissions')
            .insert(monkeySubmissions);

        if (error) throw error;

        showMessage(`Successfully submitted ${monkeyMarkers.length} monkey sightings! Session ID: ${sessionId}`, 'success');

        // Reset monkey mode
        document.getElementById('monkey-form').reset();
        clearMonkeyMarkers();
        toggleMonkeyMode();

    } catch (error) {
        console.error('Error submitting monkeys:', error);
        showMessage('Error submitting monkey sightings. Please try again.', 'error');
    }
}

document.addEventListener('DOMContentLoaded', () => {
    initMap();
    setupForms();
});
    </script>
</body>
</html>
